name: Python package

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    # Add permissions to create issues
    permissions:
      contents: read
      issues: write
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.12"]

    steps:
    # Keep original checkout (no extra parameters)
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v3
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt install -y ffmpeg
        python -m pip install --upgrade pip
        python -m pip install flake8 pytest
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Lint with flake
      id: lint
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    # Modified test step with continue-on-error and output capture
    - name: Test with pytest
      id: test
      continue-on-error: true
      run: |
        pytest 2>&1 | tee pytest_output.txt
  

    # New step to create issue on failure
    - name: Create issue on failure
      if: steps.test.outcome == 'failure' || steps.lint.outcome == 'failure'
      run: |
        # Avoid duplicate issues for same commit
        if gh issue list --label "bug" --state open --search "Test failure in ${{ github.sha }}" --json number | grep -q '"number"'; then
          echo "Issue already exists for this commit, skipping."
        else
          # Capture last 20 lines (where errors appear)
          ERROR_DETAILS=$(tail -20 pytest_output.txt)
          gh issue create \
            --title "Test failure in ${{ github.sha }}" \
            --body "**Tests failed** in commit ${{ github.sha }}.  
            **Error details (last 20 lines):**  
            \`\`\`
            $ERROR_DETAILS
            \`\`\`  
            See [run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for full logs." \
            --label "bug"
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
